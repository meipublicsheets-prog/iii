<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <?!= include('UniversalStyles'); ?>
  <style>
    /* Professional Theme Overrides */

    

    /* Compact layout overrides (Report Generator only) */
    .modal-container > div { padding: 14px !important; }
    .form-section { margin-bottom: 14px !important; }
    .form-section-title { margin-bottom: 10px !important; }

    .report-type-selector { gap: 10px !important; margin-bottom: 14px !important; }
    .report-card { padding: 14px !important; border-width: 1px !important; }
    .report-icon { font-size: 28px !important; margin-bottom: 8px !important; }
    .report-title { font-size: 0.95rem !important; margin-bottom: 4px !important; }
    .report-description { font-size: 0.8rem !important; }

    .preset-buttons { gap: 6px !important; margin-bottom: 10px !important; }
    .preset-btn { padding: 8px 10px !important; font-size: 0.8rem !important; }

    .form-row { gap: 10px !important; }
    .form-group { margin-bottom: 10px !important; }

    /* Force black buttons (Report Generator only) */
    .btn, .btn-large, .btn-success, .btn-secondary {
      background: #111827 !important;
      border-color: #111827 !important;
      color: #ffffff !important;
      padding: 10px 12px !important;
      font-size: 0.85rem !important;
      border-radius: var(--radius-sm) !important;
    }
    .btn:hover, .btn-large:hover, .btn-success:hover, .btn-secondary:hover {
      background: #0b1220 !important;
      border-color: #0b1220 !important;
      color: #ffffff !important;
    }
    .btn:disabled { opacity: 0.6 !important; cursor: not-allowed !important; }

    .button-group { padding-top: 10px !important; gap: 10px !important; }

.report-type-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .report-card {
      background: var(--bg-body);
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .report-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .report-card.selected {
      background: var(--bg-surface);
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary);
    }

    .report-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .report-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .report-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }

    .preset-btn {
      padding: 10px 14px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .preset-btn:hover {
      background: var(--bg-surface);
      border-color: var(--primary);
      color: var(--primary);
    }

    .preset-btn.active {
      background: var(--primary);
      color: var(--text-inverse);
      border-color: var(--primary);
    }

    #fbpnInputSection {
      display: none;
    }
  </style>
  <script>
    let selectedReportType = '';
    let selectedPreset = '';

    function selectReportType(type) {
      selectedReportType = type;

      document.querySelectorAll('.report-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.getElementById('report-' + type).classList.add('selected');

      // Show appropriate input section
      if (type === 'fbpnLookup') {
        document.getElementById('dateRangeSection').style.display = 'none';
        document.getElementById('fbpnInputSection').style.display = 'block';
      } else {
        document.getElementById('dateRangeSection').style.display = 'block';
        document.getElementById('fbpnInputSection').style.display = 'none';
      }
    }

    function selectPreset(preset, el) {
      selectedPreset = preset;

      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      (el || (window.event && window.event.target)).classList.add('active');

      google.script.run
        .withSuccessHandler(function (dateRange) {
          document.getElementById('startDate').value = convertToInputDate(dateRange.startDate);
          document.getElementById('endDate').value = convertToInputDate(dateRange.endDate);
        })
        .getDateRangePreset(preset);
    }

    function convertToInputDate(dateString) {
      // dateString format is likely mm/dd/yyyy from backend
      const parts = dateString.split('/');
      // Return yyyy-mm-dd
      return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
    }

    function generateReport() {
      if (!selectedReportType) {
        showAlert('Please select a report type', 'warning');
        return;
      }

      // Handle FBPN Lookup differently
      if (selectedReportType === 'fbpnLookup') {
        const fbpn = document.getElementById('fbpnInput').value.trim();
        if (!fbpn) {
          showAlert('Please enter an FBPN', 'warning');
          return;
        }

        showLoading(true, 'Generating FBPN report...');

        google.script.run
          .withSuccessHandler(function (result) {
            showLoading(false);
            if (result.success) {
              showSuccess(result);
            } else {
              showAlert(result.message, 'danger');
            }
          })
          .withFailureHandler(function (error) {
            showLoading(false);
            showAlert('Error: ' + error.message, 'danger');
          })
          .generateFbpnLookupReport(fbpn);

        return;
      }

      // Handle other reports with date ranges
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!startDate || !endDate) {
        showAlert('Please select date range', 'warning');
        return;
      }

      const start = new Date(startDate);
      const end = new Date(endDate);
      const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

      let frequency;
      if (daysDiff <= 1) {
        frequency = 'Daily';
      } else if (daysDiff <= 7) {
        frequency = 'Weekly';
      } else {
        frequency = 'Monthly';
      }

      const params = {
        frequency: frequency,
        startDate: startDate,
        endDate: endDate
      };

      showLoading(true, 'Generating ' + selectedReportType + ' report...');

      let functionName;
      if (selectedReportType === 'inbound') {
        functionName = 'generateInboundReport';
      } else if (selectedReportType === 'outbound') {
        functionName = 'generateOutboundReport';
      } else if (selectedReportType === 'cycleCount') {
        functionName = 'imsGenerateCycleCountReportPdf';
      } else if (selectedReportType === 'verification') {
        functionName = 'generateVerificationReport';
      }

      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);

          if (result.success) {
            showSuccess(result);
          } else {
            showAlert(result.message, 'danger');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showAlert('Error: ' + error.message, 'danger');
        })
      [functionName](params);
    }

    function showSuccess(result) {
      const successDiv = document.getElementById('successPanel');

      const pdfUrl = result.pdfUrl || result.url || '';
      const xlsxUrl = result.xlsxUrl || '';
      const displayName = result.name || (result.reportType ? (result.reportType + ' Report') : 'Report');

      const buttons = [];
      if (pdfUrl) buttons.push(`<a href="${pdfUrl}" target="_blank" class="btn">Open PDF</a>`);
      if (xlsxUrl) buttons.push(`<a href="${xlsxUrl}" target="_blank" class="btn">Download XLSX</a>`);

      successDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>Report Generated Successfully!</strong><br>
          ${result.rowCount ? result.rowCount + ' records included in report' : (result.message || 'Report ready')}
        </div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px;">
          ${buttons.join('') || '<span class="text-secondary">No output links were returned.</span>'}
        </div>
      `;
      successDiv.style.display = 'block';
      successDiv.scrollIntoView({ behavior: 'smooth' });
    }


    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      const container = document.querySelector('.modal-container');
      container.insertBefore(alertDiv, container.firstChild);

      setTimeout(() => alertDiv.remove(), 5000);
    }

    function showLoading(show, message = 'Processing...') {
      const overlay = document.getElementById('loadingOverlay');
      const text = document.getElementById('loadingText');
      text.textContent = message;
      if (show) overlay.classList.add('active');
      else overlay.classList.remove('active');
    }

    window.onload = function () {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = today;
      document.getElementById('endDate').value = today;
    };
  </script>
</head>

<body>
  <div class="modal-container">
    <div style="padding: 25px;">
      <!-- Report Type Selection -->
      <div class="form-section">
        <h2 class="form-section-title">1. Select Report Type</h2>

        <div class="report-type-selector">
          <div id="report-inbound" class="report-card" onclick="selectReportType('inbound')">
            <div class="report-icon" style="font-size:32px; color: var(--primary);">IN</div>
            <div class="report-title">Inbound Report</div>
            <div class="report-description">Track incoming inventory from Master_Log</div>
          </div>

          <div id="report-outbound" class="report-card" onclick="selectReportType('outbound')">
            <div class="report-icon" style="font-size:32px; color: var(--success);">OUT</div>
            <div class="report-title">Outbound Report</div>
            <div class="report-description">Track outgoing inventory from OutboundLog</div>
          </div>

          <div id="report-cycleCount" class="report-card" onclick="selectReportType('cycleCount')">
            <div class="report-icon" style="font-size:32px; color: var(--warning);">CC</div>
            <div class="report-title">Cycle Count Report</div>
            <div class="report-description">Weekly summary of cycle count performance</div>
          </div>

          <div id="report-verification" class="report-card" onclick="selectReportType('verification')">
            <div class="report-icon" style="font-size:32px; color: #059669;">VER</div>
            <div class="report-title">Verification Report</div>
            <div class="report-description">Inbound skid verification logs and variance</div>
          </div>

          <div id="report-fbpnLookup" class="report-card" onclick="selectReportType('fbpnLookup')">
            <div class="report-icon" style="font-size:32px; color: #6366f1;">FBPN</div>
            <div class="report-title">FBPN Lookup Report</div>
            <div class="report-description">Comprehensive FBPN analysis & history</div>
          </div>
        </div>
      </div>
    </div>

    <!-- FBPN Input Section -->
    <div id="fbpnInputSection" class="form-section">
      <h2 class="form-section-title">2. Enter FBPN</h2>

      <div class="form-group">
        <label class="form-label required">FBPN</label>
        <input type="text" id="fbpnInput" class="form-input" placeholder="Enter FBPN (e.g., FB12345)"
          style="text-transform: uppercase;">
      </div>

      <div class="button-group" style="border-top: none; padding-top: 0;">
        <button class="btn btn-secondary" onclick="google.script.host.close()">Close</button>
        <button class="btn btn-success btn-large" onclick="generateReport()">Generate Report</button>
      </div>
    </div>

    <!-- Date Range Selection -->
    <div id="dateRangeSection" class="form-section" style="display: none;">
      <h2 class="form-section-title">2. Select Date Range</h2>

      <div class="alert alert-info">
        <strong>Quick Presets:</strong> Click a preset below or manually select dates
      </div>

      <div class="preset-buttons">
        <button class="preset-btn" onclick="selectPreset('today', this)">Today</button>
        <button class="preset-btn" onclick="selectPreset('yesterday', this)">Yesterday</button>
        <button class="preset-btn" onclick="selectPreset('thisWeek', this)">This Week</button>
        <button class="preset-btn" onclick="selectPreset('lastWeek', this)">Last Week</button>
        <button class="preset-btn" onclick="selectPreset('thisMonth', this)">This Month</button>
        <button class="preset-btn" onclick="selectPreset('lastMonth', this)">Last Month</button>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label required">Start Date</label>
          <input type="date" id="startDate" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label required">End Date</label>
          <input type="date" id="endDate" class="form-input">
        </div>
      </div>

      <div class="button-group" style="border-top: none; padding-top: 0;">
        <button class="btn btn-secondary" onclick="google.script.host.close()">Close</button>
        <button class="btn btn-success btn-large" onclick="generateReport()">Generate Report</button>
      </div>
    </div>

    <!-- Success Panel -->
    <div id="successPanel" style="display: none; margin-top: 24px;"></div>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div id="loadingText" class="loading-text">Processing...</div>
  </div>
</body>

</html>